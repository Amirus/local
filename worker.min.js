!function(){function e(e){return e&&"function"==typeof e.then}function t(e){this.succeedCBs=[],this.failCBs=[],this.__hasValue=!1,this.__hasFailed=!1,this.value=void 0,e&&this.fulfill(e)}function r(t,r,n){if(null===n)t.isRejected()?r.reject(t.value):r.fulfill(t.value);else{var i;try{i=n(t.value)}catch(o){(local.logAllExceptions||o instanceof Error)&&(console.error?console.error(o,o.stack):console.log("Promise exception thrown",o,o.stack)),r.reject(o)}e(i)?s(i).chain(r):r.fulfill(i)}}function n(e,t){Array.isArray(e)||(e=[e]);var r=s(),n=e.length,i=0;if(0===n)return r.fulfill([]),r;var o=[];o.length=n;for(var a=[],l=function(e,s,l){o[s]=e,l&&a.push(s),++i==n&&(t?t(o,a)?r.fulfill(o):r.reject(o):r.fulfill(o))},c=0;n>c;c++)s(e[c]).succeed(l,c,!1).fail(l,c,!0);return r}function i(e){return n(e,function(e,t){return 0===t.length})}function o(e){return n(e,function(e,t){return t.length<e.length})}function s(r){if(arguments.length>1)return n(Array.prototype.slice.call(arguments));if(r instanceof t)return r;if(e(r)){var i=s();return r.then(function(e){i.fulfill(e)},function(e){i.reject(e)}),i}return new t(r)}var a=this;"undefined"!=typeof window?("undefined"==typeof window.local&&(window.local={}),a=window.local):"undefined"!=typeof self?("undefined"==typeof self.local&&(self.local={}),a=self.local):"undefined"!=typeof module&&(a=module.exports),t.prototype.isUnfulfilled=function(){return!this.__hasValue},t.prototype.isRejected=function(){return this.__hasFailed},t.prototype.isFulfilled=function(){return this.__hasValue&&!this.__hasFailed},t.prototype.then=function(e,t){e=e&&"function"==typeof e?e:null,t=t&&"function"==typeof t?t:null;var n=s();if(this.isUnfulfilled())this.succeedCBs.push({p:n,fn:e}),this.failCBs.push({p:n,fn:t});else{var i=this;setTimeout(function(){i.isFulfilled()?r(i,n,e):r(i,n,t)},0)}return n},t.prototype.succeed=function(e){if(this.isRejected())return this;var t=Array.prototype.slice.call(arguments,1);return this.then(function(r){return e.apply(null,[r].concat(t))})},t.prototype.fail=function(e){if(this.isFulfilled())return this;var t=Array.prototype.slice.call(arguments,1);return this.then(null,function(r){return e.apply(null,[r].concat(t))})},t.prototype.always=function(e){return this.then(e,e)},t.prototype.fulfill=function(e){if(this.isUnfulfilled()){this.value=e,this.__hasValue=!0;for(var t=0;t<this.succeedCBs.length;t++){var n=this.succeedCBs[t];r(this,n.p,n.fn)}this.succeedCBs.length=0,this.failCBs.length=0}return this},t.prototype.reject=function(e){if(this.isUnfulfilled()){this.value=e,this.__hasValue=!0,this.__hasFailed=!0;for(var t=0;t<this.failCBs.length;t++){var n=this.failCBs[t];r(this,n.p,n.fn)}this.succeedCBs.length=0,this.failCBs.length=0}return this},t.prototype.cancel=function(){var e;for(e=0;e<this.succeedCBs.length;e++)this.succeedCBs[e].p.cancel();for(e=0;e<this.failCBs.length;e++)this.failCBs[e].p.cancel();return this.succeedCBs.length=0,this.failCBs.length=0,this},t.prototype.chain=function(e){return this.then(function(t){return s(e).fulfill(t),t},function(t){return s(e).reject(t),t}),e},t.prototype.cb=function(e,t){e?this.reject(e):this.fulfill("undefined"==typeof t?null:t)},a.Promise=t,a.promise=s,a.promise.bundle=n,a.promise.all=i,a.promise.any=o}(),"undefined"!=typeof define&&define([],function(){return Promise}),"undefined"==typeof this.local&&(this.local={}),"undefined"==typeof this.local.util&&(this.local.util={}),function(){function e(){Object.defineProperty(this,"_events",{value:{},configurable:!1,enumerable:!1,writable:!0}),Object.defineProperty(this,"_suspensions",{value:0,configurable:!1,enumerable:!1,writable:!0}),Object.defineProperty(this,"_history",{value:[],configurable:!1,enumerable:!1,writable:!0})}function t(e,t){for(;e;){if(t(e))return e;e=e.parentNode}return null}function r(){for(var e,t=Array.prototype.slice.call(arguments),n={};t.length;)if(e=t.shift())for(var i in e)"undefined"!=typeof e[i]&&null!==e[i]&&(n[i]="object"!=typeof e[i]||Array.isArray(e[i])?e[i]:r(n[i],e[i]));return n}function n(e,t){var r=new CustomEvent("request",{bubbles:!0,cancelable:!0,detail:t});e.dispatchEvent(r)}function i(e){var r=t.thatisFormRelated(e);if(r){for(var n=0;n<r.form.length;n++)r.form[n].setAttribute("submitter",null);r.setAttribute("submitter","1")}}function o(e,n){var i={form:{},fieldset:{},elem:{}},a=null,l=null;if("FIELDSET"===e.tagName?a=e:"FORM"!==e.tagName&&(a=t.byTag(e,"FIELDSET")),"FORM"===e.tagName)l=e;else{var c=e.getAttribute("form")||(a?a.getAttribute("form"):null);c&&(l=n.querySelector("#"+c)),l||(l=t.byTag(e,"FORM"))}var u=s(e,l);l&&(i.form=o.fromForm(l,e)),a&&(i.fieldset=o.fromFormElement(a)),"A"===e.tagName?i.elem=o.fromAnchor(e):-1===["FORM","FIELDSET"].indexOf(e.tagName)&&(i.elem=o.fromFormElement(e));var h=r(i.form,i.fieldset,i.elem),p={};return p[/GET/i.test(h.method)?"query":"body"]=u,r(h,p)}function s(e,r,n){n||(n={});var i={};n.nofiles||(i.__fileReads=[]);for(var o=0;o<r.length;o++){var s=r[o];if(s.name&&(!e||t.byElement(s,e))){var l="1"==s.getAttribute("submitter");if("BUTTON"===s.tagName)l&&(i[s.name]=s.value);else if("INPUT"===s.tagName)switch(s.type.toLowerCase()){case"button":case"submit":l&&(i[s.name]=s.value);break;case"checkbox":s.checked&&(i[s.name]=(i[s.name]||[]).concat(s.value));break;case"radio":null!==s.getAttribute("checked")&&(i[s.name]=s.value);break;case"file":if(n.nofiles)break;if(s.multiple){for(var c,o=0;c=s.files[o];o++)a(i,s,s.files[o],o);i[s.name]=[],i[s.name].length=o}else a(i,s,s.files[0]);break;default:i[s.name]=s.value}else i[s.name]=s.value}}return i}function a(e,t,r,n){if(r){var i=new FileReader;i.onloadend=l(e,t,r,n),i.readAsDataURL(r)}}function l(e,t,r,n){var i=local.promise();return e.__fileReads.push(i),function(e){var o={content:e.target.result||null,name:r.name,formattr:t.name,size:r.size,type:r.type,lastModifiedDate:r.lastModifiedDate};"undefined"!=typeof n&&(o.formindex=n),i.fulfill(o)}}function c(e){var t=e.body?e.body.__fileReads:e.query?e.query.__fileReads:[];return local.promise.bundle(t).then(function(t){return e.body&&delete e.body.__fileReads,e.query&&delete e.query.__fileReads,t.forEach(function(t){"undefined"!=typeof t.formindex?e.body[t.formattr][t.formindex]=t:e.body[t.formattr]=t}),e})}e.prototype.suspendEvents=function(){this._suspensions++},e.prototype.resumeEvents=function(){this._suspensions--,this._suspensions<=0&&this.playbackHistory()},e.prototype.isSuspended=function(){return this._suspensions>0},e.prototype.playbackHistory=function(){for(var e;!this.isSuspended()&&(e=this._history.shift());)this.emit.apply(this,e)},e.prototype.emit=function(e){var t=Array.prototype.slice.call(arguments);if(this.isSuspended())return this._history.push(t),void 0;var r=this._events[e];if(!r)return!1;t=t.slice(1);for(var n=0,i=r.length;i>n;n++)r[n].apply(this,t);return!0},e.prototype.addListener=function(e,t){if(Array.isArray(e))return e.forEach(function(e){this.addListener(e,t)},this),void 0;if("function"!=typeof t)throw new Error("addListener only takes instances of Function");return this.emit("newListener",e,t),this._events[e]?this._events[e].push(t):this._events[e]=[t],this},e.prototype.on=e.prototype.addListener,e.prototype.once=function(e,t){var r=this;r.on(e,function n(){r.removeListener(e,n),t.apply(this,arguments)})},e.prototype.removeListener=function(e,t){if("function"!=typeof t)throw new Error("removeListener only takes instances of Function");if(!this._events[e])return this;var r=this._events[e],n=r.indexOf(t);return 0>n?this:(r.splice(n,1),0===r.length&&delete this._events[e],this)},e.prototype.removeAllListeners=function(e){return e?this._events[e]=null:this._events={},this._history[e]&&(this._history[e]=null),this},e.prototype.listeners=function(e){return this._events[e]},local.util.EventEmitter=e,local.util.mixinEventEmitter=function(t){e.call(t);for(var r in e.prototype)t[r]=e.prototype[r]},"undefined"==typeof CustomEvent&&(CustomEvent=function(e,t){var r=document.createEvent("CustomEvent");return r.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),r}),t.byTag=function(e,r){return t(e,function(e){return e.tagName==r})},t.byClass=function(e,r){return t(e,function(e){return e.classList&&e.classList.contains(r)})},t.byElement=function(e,r){return t(e,function(e){return e===r})},t.thatisFormRelated=function(e){return t(e,function(e){return!!e.form})},o.fromAnchor=function(e){if(e=t.byTag(e,"A"),!e||!e.attributes.href||"#"==e.attributes.href.value.charAt(0))return null;var r={url:e.attributes.href.value,target:e.getAttribute("target"),headers:{accept:e.getAttribute("type")}};return r},o.fromFormElement=function(e){var t={method:e.getAttribute("formmethod"),url:e.getAttribute("formaction"),target:e.getAttribute("formtarget"),headers:{"content-type":e.getAttribute("formenctype"),accept:e.getAttribute("formaccept")}};return t},o.fromForm=function(e,t){if(t&&!t.form)for(var n=0;n<e.length;n++){var i=e[n];if("1"==i.getAttribute("submitter")){t=i,i.setAttribute("submitter","0");break}}var o={submitter:{},form:{}};t&&(o.submitter={method:t.getAttribute("formmethod"),url:t.getAttribute("formaction"),target:t.getAttribute("formtarget"),headers:{"content-type":t.getAttribute("formenctype"),accept:t.getAttribute("formaccept")}}),o.form={method:e.getAttribute("method"),url:e.getAttribute("action"),target:e.getAttribute("target"),headers:{"content-type":e.getAttribute("enctype")||e.enctype,accept:e.getAttribute("accept")}},e.acceptCharset&&(o.form.headers.accept=e.acceptCharset);var s=r(o.form,o.submitter);return s},local.util.findParentNode=t,local.util.trackFormSubmitter=i,local.util.dispatchRequestEvent=n,local.util.extractRequest=o,local.util.extractRequestPayload=s,local.util.finishPayloadFileReads=c,local.util.deepClone=function(e){return JSON.parse(JSON.stringify(e))}}(),"undefined"==typeof this.local&&(this.local={}),function(){function e(e){var t=e.match(/\s*(\S+)\/([^;\s]+)\s*(?:;(.*))?/);if(!t)return null;var r=t[1],n=t[2],i=""+r+"/"+n,o={},s=1;return t[3]&&(o=t[3].split(";").map(function(e){return e.trim().split("=")}).reduce(function(e,t){return e[t[0]]=t[1],e},o),null!==o.q&&(s=parseFloat(o.q),delete o.q)),{type:r,subtype:n,params:o,q:s,full:i}}function t(e,t){var r=t.filter(function(t){return n(e,t)}).sort(function(e,t){return e.q>t.q?-1:1});return r[0]?r[0].q:0}function r(e,t){return"*"===e||e===t}function n(t,n){var i=e(t);if(n.params){var o=Object.keys(n.params);if(o.some(function(e){return!r(n.params[e],i.params[e])}))return null}return r(n.type,i.type)&&r(n.subtype,i.subtype)?n:void 0}function i(e,t){if(!e||"object"!=typeof e||!t)return e;var r=l(t,"serializer");return r?r(e):e}function o(e,t){if(!e||"string"!=typeof e||!t)return e;var r=l(t,"deserializer");if(!r)return e;try{return r(e)}catch(n){return console.warn("Failed to deserialize content",t,e),e}}function s(e,t,r){U[e]={serializer:t,deserializer:r}}function a(e){var t=e.split(";"),r=t[0];if(t=r.split("/"),t[1]){var n=t[1].split("+");return n[1]?[r,t[0]+"/"+n[1],t[0]]:[r,t[0]]}return[r]}function l(e,t){for(var r=a(e),n=0;n<r.length;n++)if(r[n]in U)return U[r[n]][t];return null}function c(e){var t=e.indexOf(":");return[e.slice(0,t).trim(),e.slice(t+1).trim()]}function u(e){local.util.EventEmitter.call(this),e||(e={}),"string"==typeof e&&(e={url:e}),this.method=e.method?e.method.toUpperCase():"GET",this.url=e.url||null,this.path=e.path||null,this.query=e.query||{},this.headers=e.headers||{},this.body="",e.body&&!this.headers["content-type"]&&(this.headers["content-type"]="string"==typeof e.body?"text/plain":"application/json"),this.headers.accept||(this.headers.accept="*/*"),Object.defineProperty(this,"body",{value:"",configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"stream",{value:e.stream||!1,configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"binary",{value:e.binary||!1,configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"isConnOpen",{value:!0,configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"body_",{value:local.promise(),configurable:!0,enumerable:!1,writable:!1}),function(e){e.on("data",function(t){e.body+=t}),e.on("end",function(){e.headers["content-type"]&&(e.body=local.contentTypes.deserialize(e.body,e.headers["content-type"])),e.body_.fulfill(e.body)})}(this)}function h(){local.util.EventEmitter.call(this),this.status=0,this.reason=null,this.headers={},this.body="",Object.defineProperty(this,"isConnOpen",{value:!0,configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"latency",{value:void 0,configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"body_",{value:local.promise(),configurable:!0,enumerable:!1,writable:!1}),function(e){e.on("data",function(t){t instanceof ArrayBuffer?e.body=t:e.body+=t}),e.on("end",function(){e.headers["content-type"]&&(e.body=local.contentTypes.deserialize(e.body,e.headers["content-type"])),e.body_.fulfill(e.body)})}(this)}function p(e){if(this.config={domain:null},e)for(var t in e)this.config[t]=e[t]}function f(e){p.call(this,e),this.sidCounter=1,this.incomingStreams={},this.msgBuffer=[]}function d(e){return""===e?!1:(e=e.replace(/\\./g,"@").replace(/"[^"\\\n\r]*"/g,""),/^[,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]*$/.test(e))}function y(e){return e?isNaN(e.sid)?!1:!0:!1}function g(e,t){if(!e||!e.src)throw new Error("WorkerBridgeServer requires config with `src` attribute.");local.BridgeServer.call(this,e),this.isUserScriptActive=!1,this.hasHostPrivileges=!0,e.serverFn&&(this.handleRemoteWebRequest=e.serverFn,delete this.config.serverFn),this.loadCb=t,this.config.domain||(this.config.domain="<"+this.config.src.slice(0,40)+">"),this.config.environmentHost=window.location.host,this.config.shared?(this.worker=new SharedWorker(e.bootstrapUrl||local.workerBootstrapUrl,e.namespace),this.worker.port.start()):this.worker=new Worker(e.bootstrapUrl||local.workerBootstrapUrl),this.getPort().addEventListener("message",function(e){var t=e.data;if(!t)return console.error("Invalid message from worker: Payload missing",this,e);switch(this.config.log&&console.debug("WORKER received",t),t.op){case"ready":this.onWorkerReady(t.body);break;case"loaded":this.onWorkerUserScriptLoaded(t.body);break;case"log":this.onWorkerLog(t.body);break;case"terminate":this.terminate();break;default:this.onChannelMessage(t)}}.bind(this))}function m(e,t){if(e&&Array.isArray(e))for(var r=0,n=e.length;n>r;r++)m(e[r],t);else H[e]=t}function v(e){delete H[e]}function b(e){return H[e]}function w(e,t){t.headers.link&&t.headers.link.forEach(function(t){M.test(t.href)===!1&&(t.href=local.joinRelPath(e.urld,t.href))})}function A(e){var t=/^([^.^:]*):/.exec(e);return t?t[1]:0===e.indexOf("//")?"http":0===e.indexOf("||")?"rel":"httpl"}function S(e,t){local.util.EventEmitter.call(this),this.request=e,this.response=null,this.response_=null,this.lastEventId=-1,this.isConnOpen=!0,this.connect(t)}function E(e){this.emit("message",e),this.emit("error",e)}function C(e){e=local.contentTypes.deserialize(e,"text/event-stream");var t=parseInt(e.id,10);"undefined"!=typeof t&&t>this.lastEventId&&(this.lastEventId=t),this.emit("message",e),this.emit(e.event,e)}function R(){this.streams=[]}function T(e){this.query=e,this.resolveState=T.UNRESOLVED,this.error=null,this.queryIsAbsolute="string"==typeof e&&local.isAbsUri(e),this.queryIsAbsolute?(this.url=e,this.urld=local.parseUri(this.url)):(this.url=null,this.urld=null)}function x(e,t){if(this.context=e||null,this.parentNavigator=t||null,this.links=null,this.requestDefaults=null,this.context.isRelative()&&!t)throw new Error("A parentNavigator is required for navigators with relative contexts")}function k(e,t){for(var r in t)"headers"==r||e[r]||(e[r]="object"==typeof t[r]?local.util.deepClone(t[r]):t[r]);t.headers&&(e.headers||(e.headers={}),k(e.headers,t.headers))}function P(e){return function(t,r){var n=r||{};return n.headers=t||{},n.method=e,this.dispatch(n)}}function O(e){return function(t,r,n){var i=n||{};return i.headers=r||{},i.method=e,i.body=t,this.dispatch(i)}}local.LINK_NOT_FOUND=1;var L=/<(.*?)>(?:;[\s]*([^,]*))/g,q=/([\-a-z0-9\.]+)=?(?:(?:"([^"]+)")|([^;\s]+))?/g;local.parseLinkHeader=function(e){if("string"!=typeof e)return e;for(var t,r,n,i=[];t=L.exec(e);){for(n={href:t[1]};r=q.exec(t[2]);)n[r[1]]=r[2]||r[3]||!0;i.push(n)}return i},local.queryLinks=function(e,t){return e?(e.headers&&(e=e.headers.link),Array.isArray(e)?e.filter(function(e){return local.queryLink(e,t)>0}):[]):[]},local.queryLinks1=function(e,t){var r=local.queryLinks(e,t);return r[0]},local.queryLink=function(e,t){for(var r in t)if("rel"==r)for(var n=t.rel.split(/\s+/),i=0;i<n.length;i++){var o=!0;if("!"==n[i].charAt(0)&&(n[i]=n[i].slice(1),o=!1),RegExp("(\\s|^)(.*//)?"+n[i]+"(\\s|$)","i").test(e.rel)!==o)return!1}else if("undefined"==typeof e[r]){if(RegExp("\\{[^\\}]*"+r+"[^\\{]*\\}","i").test(e.href)===!1)return!1}else if(e[r]!=t[r])return!1;return!0},local.parseAcceptHeader=function(t){return t.split(",").map(function(t){return e(t.trim())}).filter(function(e){return e&&e.q>0})},local.preferredTypes=function(e,r){return"object"==typeof e&&(e=e.headers.accept),e=local.parseAcceptHeader(e||""),r?(Array.isArray(r)||(r=[r]),r.map(function(r){return[r,t(r,e)]}).filter(function(e){return e[1]>0}).sort(function(e,t){return e[1]===t[1]?0:e[1]>t[1]?-1:1}).map(function(e){return e[0]})):e.map(function(e){return e.full})},local.preferredType=function(e,t){return local.preferredTypes(e,t)[0]},local.joinUrl=function(){var e=Array.prototype.map.call(arguments,function(e,t){e=""+e;var r=0,n=e.length;return"/"==e?"":(0!==t&&"/"===e.charAt(0)&&(r+=1),"/"===e.charAt(n-1)&&(n-=1),e.substring(r,n))});return e.join("/")};var I=/^((http(s|l)?:)?\/\/)|((nav:)?\|\|)/;local.isAbsUri=function(e){return I.test(e)};var D=/^(nav:)?\|?\|/i;local.isNavSchemeUri=function(e){return D.test(e)},local.joinRelPath=function(e,t){"string"==typeof e&&(e=local.parseUri(e));var r=e.protocol?e.protocol+"://":!1;if(r||(r=0===e.source.indexOf("//")?"//":0===e.source.indexOf("||")?"||":"httpl://"),"/"==t.charAt(0))return r+e.authority+t;for(var n=e.path,i=n.split("/"),o=t.split("/"),s=0,a=o.length;a>s;s++)"."!=o[s]&&(".."==o[s]?i.pop():i.push(o[s]));return local.joinUrl(r+e.authority,i.join("/"))},local.parseUri=function(e){if("object"==typeof e&&(e.url?e=e.url:(e.host||e.path)&&(e=local.joinUrl(req.host,req.path))),"data:"==e.slice(0,5))return{protocol:"data",source:e};for(var t=local.parseUri.options,r=t.parser[t.strictMode?"strict":"loose"].exec(e),n={},i=14;i--;)n[t.key[i]]=r[i]||"";return n[t.q.name]={},n[t.key[12]].replace(t.q.parser,function(e,r,i){r&&(n[t.q.name][r]=i)}),n},local.parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},local.parseNavUri=function(e){if(!e)return[];var t=e.indexOf("||");-1!==t&&(e=e.slice(t+2));for(var r=e.split("|"),n=1;n<r.length;n++){for(var i={},o=r[n].split(","),s=0;s<o.length;s++){var a=o[s].split("=");0===s?(i.rel=a[0].replace(/\+/," "),a[1]&&(i.id=a[1])):i[a[0]]=decodeURIComponent(a[1]).replace(/\+/," ")}r[n]=i}return r[0]||r.shift(),r},local.pipe=function(e,t,r,n){return r=r||function(e){return e},n=n||function(e){return e},local.promise(t).succeed(function(t){return e.status||e.writeHead(t.status,t.reason,r(t.headers)),null!==t.body&&"undefined"!=typeof t.body&&e.write(n(t.body)),t.on&&t.isConnOpen?(t.on("data",function(t){e.write(n(t))}),t.on("end",function(){e.end()})):e.end(),e}).fail(function(t){var r=t.headers["content-type"]||"text/plain",n=r&&t.body?t.body:"";throw e.writeHead(502,"bad gateway",{"content-type":r}),e.end(n),t})};var N={serialize:i,deserialize:o,register:s},U={};local.contentTypes=N,local.contentTypes.register("application/json",function(e){try{return JSON.stringify(e)}catch(t){return t.message}},function(e){try{return JSON.parse(e)}catch(t){return t.message}}),local.contentTypes.register("application/x-www-form-urlencoded",function(e){var t=encodeURIComponent,r=[];for(var n in e)if(null===e[n])r.push(n+"=");else if(Array.isArray(e[n]))for(var i=0;i<e[n].length;i++)r.push(n+"[]="+t(e[n][i]));else if("object"==typeof e[n])for(var o in e[n])r.push(n+"["+o+"]="+t(e[n][o]));else r.push(n+"="+t(e[n]));return r.join("&")},function(e){for(var t=e.split("&"),r={},n=0;n<t.length;n++){var i=t[n].split("="),o=decodeURIComponent(i[0]),s=decodeURIComponent(i[1]),a=/\[\]$/.test(o),l=o.match(/^(.+)\[([^\]]+)\]$/);if(l){o=l[1];var c=l[2];r[o]=r[o]||{},r[o][c]=s}else a?(o=o.substring(0,o.length-2),r[o]=r[o]||[],r[o].push(s)):r[o]=s}return r}),local.contentTypes.register("text/event-stream",function(e){return"undefined"!=typeof e.data?"event: "+e.event+"\r\ndata: "+JSON.stringify(e.data)+"\r\n\r\n":"event: "+e.event+"\r\n\r\n"},function(e){var t={};e.split("\r\n").forEach(function(e){/^[\s]*$/.test(e)||(e=c(e),e[0]&&(t[e[0]]=e[1]))});try{t.data=JSON.parse(t.data)}catch(r){}return t}),local.Request=u,u.prototype=Object.create(local.util.EventEmitter.prototype),u.prototype.setHeader=function(e,t){this.headers[e]=t},u.prototype.getHeader=function(e){return this.headers[e]},u.prototype.removeHeader=function(e){delete this.headers[e]},u.prototype.finishStream=function(){return this.body_},u.prototype.setTimeout=function(e){var t=this;setTimeout(function(){t.isConnOpen&&t.close()},e)},u.prototype.serializeHeaders=function(){if(this.headers.authorization&&"object"==typeof this.headers.authorization){if(!this.headers.authorization.scheme)throw new Error("`scheme` required for auth headers");var e;switch(this.headers.authorization.scheme.toLowerCase()){case"basic":e="Basic "+btoa(this.headers.authorization.name+":"+this.headers.authorization.password);break;case"persona":e="Persona name="+this.headers.authorization.name+" assertion="+this.headers.authorization.assertion;break;default:throw new Error("unknown auth sceme: "+this.headers.authorization.scheme)}this.headers.authorization=e}if(this.headers.via&&"object"==typeof this.headers.via){var t=this.headers.via;Array.isArray(t)||(t=[t]),this.headers.via=t.map(function(e){return[(e.protocol.name?e.protocol.name+"/":"")+e.protocol.version,e.host,e.comment?e.comment:""].join(" ")}).join(", ")}},u.prototype.write=function(e){this.isConnOpen&&("string"!=typeof e&&(e=local.contentTypes.serialize(e,this.headers["content-type"])),this.emit("data",e))},u.prototype.end=function(e){this.isConnOpen&&("undefined"!=typeof e&&this.write(e),this.emit("end"))},u.prototype.close=function(){this.isConnOpen&&(this.isConnOpen=!1,this.emit("close"))},local.Response=h,h.prototype=Object.create(local.util.EventEmitter.prototype),h.prototype.setHeader=function(e,t){this.headers[e]=t},h.prototype.getHeader=function(e){return this.headers[e]},h.prototype.removeHeader=function(e){delete this.headers[e]},h.prototype.writeHead=function(e,t,r){if(this.isConnOpen){if(this.status=e,this.reason=t,r)for(var n in r)r.hasOwnProperty(n)&&this.setHeader(n,r[n]);return this.emit("headers",this),this}},h.prototype.write=function(e){this.isConnOpen&&("string"!=typeof e&&(e=local.contentTypes.serialize(e,this.headers["content-type"])),this.emit("data",e))},h.prototype.end=function(e){this.isConnOpen&&("undefined"!=typeof e&&this.write(e),this.emit("end"),this.close())},h.prototype.close=function(){this.isConnOpen&&(this.isConnOpen=!1,this.emit("close"))},local.Server=p,p.prototype.getUrl=function(){return"httpl://"+this.config.domain},p.prototype.handleLocalWebRequest=function(e,t){console.warn("handleLocalWebRequest not defined",this),t.writeHead(500,"server not implemented"),t.end()},p.prototype.terminate=function(){},f.prototype=Object.create(p.prototype),local.BridgeServer=f,f.prototype.isChannelActive=function(){return console.warn("isChannelActive not defined",this),!1},f.prototype.channelSendMsg=function(e){console.warn("channelSendMsg not defined",this,e)},f.prototype.handleRemoteWebRequest=function(e,t){console.warn("handleRemoteWebRequest not defined",this),t.writeHead(500,"server not implemented"),t.end()},f.prototype.flushBufferedMessages=function(){this.msgBuffer.forEach(function(e){this.channelSendMsg(e)},this),this.msgBuffer.length=0},f.prototype.channelSendMsgWhenReady=function(e){this.isChannelActive()?this.channelSendMsg(e):this.msgBuffer.push(e)},f.prototype.handleLocalWebRequest=function(e,t){var r=this.sidCounter++,n={sid:r,method:e.method,path:e.path,query:e.query,headers:e.headers};this.incomingStreams[-n.sid]=t,this.channelSendMsgWhenReady(JSON.stringify(n));var i=this;e.on("data",function(e){i.channelSendMsgWhenReady(JSON.stringify({sid:r,body:e}))}),e.on("end",function(){i.channelSendMsgWhenReady(JSON.stringify({sid:r,end:!0}))})},f.prototype.onChannelMessage=function(e){if("string"==typeof e){if(!d(e))return console.warn("Dropping malformed HTTPL message",e,this),void 0;e=JSON.parse(e)}if(!y(e))return console.warn("Dropping malformed HTTPL message",e,this),void 0;var t=this.incomingStreams[e.sid];if(!t){if(!(e.sid>0))return console.warn("Dropping unexpected HTTPL response message",e,this),void 0;var r=new local.Request({method:e.method,path:e.path,query:e.query,headers:e.headers}),n=new local.Response,i=this,o=-e.sid;n.on("headers",function(){i.channelSendMsg(JSON.stringify({sid:o,status:n.status,reason:n.reason,headers:n.headers}))}),n.on("data",function(e){i.channelSendMsg(JSON.stringify({sid:o,body:e}))}),n.on("close",function(){i.channelSendMsg(JSON.stringify({sid:o,end:!0}))}),this.handleRemoteWebRequest(r,n),t=this.incomingStreams[e.sid]=r}e.sid<0&&"undefined"!=typeof e.status&&t.writeHead(e.status,e.reason,e.headers),e.body&&t.write(e.body),e.end&&(t.end(),t.close(),delete this.incomingStreams[e.sid])},g.prototype=Object.create(local.BridgeServer.prototype),local.WorkerBridgeServer=g,g.prototype.getPort=function(){return this.worker.port?this.worker.port:this.worker},g.prototype.terminate=function(){this.worker.terminate(),this.worker=null,this.isUserScriptActive=!1},g.prototype.nullify=function(e){this.channelSendMsg({op:"nullify",body:e})},g.prototype.importScripts=function(e){this.channelSendMsg({op:"importScripts",body:e})},g.prototype.isChannelActive=function(){return this.isUserScriptActive},g.prototype.channelSendMsg=function(e){this.config.log&&console.debug("WORKER sending",e),this.getPort().postMessage(e)},g.prototype.onWorkerReady=function(e){if(this.hasHostPrivileges=e.hostPrivileges,this.hasHostPrivileges){this.config.nullify&&this.config.nullify.forEach(function(e){this.nullify(e)},this);var t=this.config.src;0===t.indexOf("data:application/javascript,")&&(t="data:application/javacsript;base64,"+btoa(t.slice(28))),this.channelSendMsg({op:"configure",body:this.config}),this.importScripts(t)}else this.onWorkerUserScriptLoaded()},g.prototype.onWorkerUserScriptLoaded=function(e){this.loadCb&&"function"==typeof this.loadCb&&this.loadCb(e),e&&e.error?(console.error("Failed to load user script in worker, terminating",e,this),this.terminate()):(this.isUserScriptActive=!0,this.flushBufferedMessages())},g.prototype.onWorkerLog=function(e){if(e){if(!Array.isArray(e))return console.error('Received invalid "log" operation: Payload must be an array',e);var t=e.shift(),r=["["+this.config.domain+"]"].concat(e);switch(t){case"error":console.error.apply(console,r);break;case"warn":console.warn.apply(console,r);break;default:console.log.apply(console,r)}}},function(){function e(){return Math.round(1e4*Math.random())}function t(e){if(e||(e={}),!e.peer)throw new Error("`config.peer` is required");if(!e.relay)throw new Error("`config.relay` is required");local.BridgeServer.call(this,e),local.util.mixinEventEmitter(this);var t=g.exec(e.peer);if(!t)throw new Error("Invalid peer URL: "+e.peer);this.peerInfo={user:t[1],provider:t[2],app:t[3],stream:t[4]},this.isConnecting=!0,this.isOfferExchanged=!1,this.isConnected=!1,this.candidateQueue=[],this.signalBacklog=[],this.retrySignalTimeout=null,this.retrySignalWaitDuration=500;var s=e.iceServers||d;this.rtcPeerConn=new webkitRTCPeerConnection(s,p),this.rtcPeerConn.onicecandidate=a.bind(this),this.rtcPeerConn.onicechange=l.bind(this),this.rtcPeerConn.oniceconnectionstatechange=l.bind(this),this.rtcPeerConn.onsignalingstatechange=c.bind(this),this.rtcDataChannel=this.rtcPeerConn.createDataChannel("httpl",{ordered:!0,reliable:!0}),this.rtcDataChannel.onopen=n.bind(this),this.rtcDataChannel.onclose=i.bind(this),this.rtcDataChannel.onerror=o.bind(this),this.rtcDataChannel.onmessage=r.bind(this),this.config.initiate&&this.sendOffer()}function r(e){this.debugLog("HTTPL CHANNEL MSG",e),this.onChannelMessage(e.data)}function n(e){this.debugLog("HTTPL CHANNEL OPEN",e),this.isConnecting=!1,this.isConnected=!0,this.flushBufferedMessages(),this.emit("connected",{peer:this.peerInfo,domain:this.config.domain,server:this})}function i(e){this.debugLog("HTTPL CHANNEL CLOSE",e),this.terminate({noSignal:!0})}function o(e){this.debugLog("HTTPL CHANNEL ERR",e),this.emit("error",{peer:this.peerInfo,domain:this.config.domain,server:this,err:e})}function s(){var e=this;this.isOfferExchanged=!0,this.candidateQueue.forEach(function(t){e.rtcPeerConn.addIceCandidate(new RTCIceCandidate({candidate:t}))}),this.candidateQueue.length=0}function a(e){e&&e.candidate&&(this.debugLog("FOUND ICE CANDIDATE",e.candidate),this.signal({type:"candidate",candidate:e.candidate.candidate}))}function l(e){e.target&&"disconnected"===e.target.iceConnectionState&&(this.debugLog("ICE CONNECTION STATE CHANGE: DISCONNECTED",e),this.terminate({noSignal:!0}))}function c(e){e.target&&"closed"==e.target.signalingState&&(this.debugLog("SIGNALING STATE CHANGE: DISCONNECTED",e),this.terminate({noSignal:!0}))}function u(e){return e.replace(y,"b=AS:102400")}function h(t){if(!t)throw new Error("PeerWebRelay requires the `config` parameter");if(!t.provider)throw new Error("PeerWebRelay requires `config.provider`");if(!t.serverFn)throw new Error("PeerWebRelay requires `config.serverFn`");t.app||(t.app=window.location.host),"undefined"==typeof t.stream&&(t.stream=e()),"undefined"==typeof t.ping&&(t.ping=45e3),this.config=t,local.util.mixinEventEmitter(this),this.myPeerDomain=null,this.connectedToRelay=!1,this.userId=null,this.accessToken=null,this.bridges={},this.pingInterval=null;var r=local.parseUri(t.provider);this.providerDomain=r.host,this.messageFromAuthPopupHandler=null,this.p2pwServiceAPI=local.navigator(t.provider),this.accessTokenAPI=this.p2pwServiceAPI.follow({rel:"grimwire.com/-access-token",app:t.app}),this.accessTokenAPI.resolve({nohead:!0}),this.p2pwUsersAPI=this.p2pwServiceAPI.follow({rel:"grimwire.com/-user collection"}),this.p2pwRelayAPI=null,this.relayStream=null,window.addEventListener("beforeunload",this.onPageClose.bind(this))}var p={optional:[{RtpDataChannels:!0}]},f={optional:[],mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}},d={iceServers:[{url:"stun:stun.l.google.com:19302"}]};t.prototype=Object.create(local.BridgeServer.prototype),local.RTCBridgeServer=t,t.prototype.getPeerInfo=function(){return this.peerInfo},t.prototype.debugLog=function(){var e=[this.config.domain].concat([].slice.call(arguments));console.debug.apply(console,e)},t.prototype.terminate=function(e){(this.isConnecting||this.isConnected)&&(e&&e.noSignal||this.signal({type:"disconnect"}),this.isConnecting=!1,this.isConnected=!1,this.emit("disconnected",{peer:this.peerInfo,domain:this.config.domain,server:this}),this.rtcPeerConn&&(this.rtcPeerConn.close(),this.rtcPeerConn=null))},t.prototype.isChannelActive=function(){return this.isConnected},t.prototype.channelSendMsg=function(e){this.rtcDataChannel.send(e)},t.prototype.handleRemoteWebRequest=function(e,t){t.writeHead(500,"not implemented"),t.end()
},t.prototype.onSignal=function(e){var t=this;switch(this.debugLog("SIG",e),e.type){case"disconnect":this.terminate({noSignal:!0});break;case"candidate":this.debugLog("GOT CANDIDATE",e.candidate),this.isOfferExchanged?this.rtcPeerConn.addIceCandidate(new RTCIceCandidate({candidate:e.candidate})):this.candidateQueue.push(e.candidate);break;case"offer":this.debugLog("GOT OFFER",e),this.emit("connecting",{peer:this.peerInfo,domain:this.config.domain,server:this});var r=new RTCSessionDescription({type:"offer",sdp:e.sdp});this.rtcPeerConn.setRemoteDescription(r),s.call(t),this.rtcPeerConn.createAnswer(function(e){t.debugLog("CREATED ANSWER",e),e.sdp=u(e.sdp),t.rtcPeerConn.setLocalDescription(e),t.signal({type:"answer",sdp:e.sdp})},null,f);break;case"answer":this.debugLog("GOT ANSWER",e),this.rtcPeerConn.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:e.sdp})),s.call(t);break;default:console.warn("RTCBridgeServer - Unrecognized signal message from relay",e)}},t.prototype.signal=function(e){if(this.retrySignalTimeout)return this.signalBacklog.push(e),void 0;var t=this;this.config.relay.signal(this.config.peer,e).fail(function(r){504==r.status&&(t.signalBacklog.push(e),t.retrySignalTimeout||(t.retrySignalTimeout=setTimeout(t.retrySignal.bind(t),t.retrySignalWaitDuration)))})},t.prototype.retrySignal=function(){if(this.retrySignalTimeout=null,0!==this.signalBacklog.length){var e=this;this.config.relay.signal(this.config.peer,this.signalBacklog[0]).then(function(){this.retrySignalWaitDuration=500;var t=e.signalBacklog;e.signalBacklog=[];for(var r=1;r<t.length;r++)e.signal(t[r])}).fail(function(t){504==t.status&&(e.retrySignalTimeout||(e.retrySignalWaitDuration<3e4&&(e.retrySignalWaitDuration+=500),e.retrySignalTimeout=setTimeout(e.retrySignal.bind(e),e.retrySignalWaitDuration)))})}},t.prototype.sendOffer=function(){var e=this;this.rtcPeerConn.createOffer(function(t){e.debugLog("CREATED OFFER",t),t.sdp=u(t.sdp),e.rtcPeerConn.setLocalDescription(t),e.signal({type:"offer",sdp:t.sdp})},null,f),setTimeout(function(){e.emit("connecting",{peer:e.peerInfo,domain:e.config.domain,server:e})},0)};var y=/b\=AS\:([\d]+)/i;local.PeerWebRelay=h,h.prototype.setAccessToken=function(e){if(e){var t=e.split(":");if(2!==t.length)throw new Error("Invalid access token");this.userId=t[0],this.accessToken=e,this.p2pwServiceAPI.setRequestDefaults({headers:{authorization:"Bearer "+e}}),this.p2pwUsersAPI.setRequestDefaults({headers:{authorization:"Bearer "+e}});var r=this;this.p2pwRelayAPI=this.p2pwServiceAPI.follow({rel:"item grimwire.com/-p2pw/relay",id:this.getUserId(),stream:this.getStreamId(),nc:Date.now()}),this.p2pwRelayAPI.resolve().then(function(){r.emit("accessGranted")},function(e){r.onRelayError({event:"error",data:e})})}else{var n=!!this.accessToken;this.userId=null,this.accessToken=null,n&&this.emit("accessRemoved")}},h.prototype.isListening=function(){return this.connectedToRelay},h.prototype.getDomain=function(){return this.myPeerDomain},h.prototype.getUserId=function(){return this.userId},h.prototype.getPeer=function(e){return this.bridges[e]},h.prototype.getApp=function(){return this.config.app},h.prototype.getStreamId=function(){return this.config.stream},h.prototype.setStreamId=function(e){this.config.stream=e},h.prototype.getAccessToken=function(){return this.accessToken},h.prototype.getProvider=function(){return this.config.provider},h.prototype.setProvider=function(e){if(this.connectedToRelay)throw new Error("Can not change provider while connected to the relay. Call stopListening() first.");this.config.provider=e,this.providerDomain=local.parseUri(e).host,this.p2pwServiceAPI.rebase(e),this.accessTokenAPI.unresolve().resolve({nohead:!0}),this.p2pwUsersAPI.unresolve(),this.p2pwRelayAPI&&this.p2pwRelayAPI.unresolve()},h.prototype.requestAccessToken=function(){this.messageFromAuthPopupHandler||(this.messageFromAuthPopupHandler=function(e){console.debug("Message (from "+e.origin+"): "+e.data);var t=local.parseUri(e.origin),r=local.parseUri(this.config.provider);t.authority===r.authority&&(this.setAccessToken(e.data),window.removeEventListener("message",this.messageFromAuthPopupHandler),e.data||this.emit("accessDenied"))}.bind(this)),window.addEventListener("message",this.messageFromAuthPopupHandler),this.accessTokenAPI.context.url?window.open(this.accessTokenAPI.context.url):this.accessTokenAPI.resolve({nohead:!0}).always(function(e){window.open(e)})},h.prototype.getUsers=function(e){var t=this.p2pwUsersAPI;return e&&(e.rel="self",t=t.follow(e)),t.get({accept:"application/json"})},h.prototype.startListening=function(){var e=this;this.getAccessToken()&&(this.myPeerDomain=this.makeDomain(this.getUserId(),this.config.app,this.config.stream),this.p2pwRelayAPI=this.p2pwServiceAPI.follow({rel:"item grimwire.com/-p2pw/relay",id:this.getUserId(),stream:this.getStreamId(),nc:Date.now()}),this.p2pwRelayAPI.subscribe({method:"subscribe"}).then(function(t){e.relayStream=t,e.connectedToRelay=!0,t.response_.then(function(t){return e.emit("listening"),t}),t.on("signal",e.onSignal.bind(e)),t.on("error",e.onRelayError.bind(e)),t.on("close",e.onRelayClose.bind(e)),e.pingInterval&&clearInterval(e.pingInterval),e.config.ping&&(e.pingInterval=setInterval(function(){e.signal(e.getDomain(),{type:"noop"})},e.config.ping))},function(t){e.onRelayError({event:"error",data:t})}))},h.prototype.stopListening=function(){this.connectedToRelay&&(this.connectedToRelay=!1,this.relayStream.close(),this.relayStream=null)},h.prototype.connect=function(e,t){if(t||(t={}),"undefined"==typeof t.initiate&&(t.initiate=!0),e in this.bridges)return this.bridges[e];var r=local.parseUri(e),n=r.host.split("!"),i=n[0],o=n[1];if(!(r.user&&i&&o&&r.port))throw new Error("Invalid peer url given to connect(): "+e);var s=new local.RTCBridgeServer({peer:e,initiate:t.initiate,relay:this});return s.handleRemoteWebRequest=this.config.serverFn,s.on("connecting",this.emit.bind(this,"connecting")),s.on("connected",this.emit.bind(this,"connected")),s.on("disconnected",this.onBridgeDisconnected.bind(this)),s.on("disconnected",this.emit.bind(this,"disconnected")),s.on("error",this.emit.bind(this,"error")),this.bridges[r.authority]=s,local.registerLocal(r.authority,s),s},h.prototype.signal=function(e,t){return this.p2pwRelayAPI?this.p2pwRelayAPI.post({src:this.myPeerDomain,dst:e,msg:t}):(console.warn("PeerWebRelay - signal() called before relay is connected"),void 0)},h.prototype.onSignal=function(e){if(e.data&&e.data.src&&e.data.msg||console.warn("discarding faulty signal message",err),"noop"!=e.data.msg.type){var t=e.data.src,r=this.bridges[t];r?r.onSignal(e.data.msg):"offer"==e.data.msg.type&&(r=this.connect(t,{initiate:!1}),r.onSignal(e.data.msg))}},h.prototype.onRelayError=function(e){if(e.data&&423==e.data.status)this.relayStream=null,this.connectedToRelay=!1,this.emit("streamTaken");else if(!e.data||401!=e.data.status&&403!=e.data.status)if(e.data&&(0===e.data.status||404==e.data.status||e.data.status>=500)){this.relayStream=null,this.connectedToRelay=!1;var t=this;setTimeout(function(){t.startListening()},2e3)}else this.emit("error",e);else this.setAccessToken(null),this.emit("accessInvalid")},h.prototype.onRelayClose=function(){var e=this.connectedToRelay;this.connectedToRelay=!1,self.pingInterval&&clearInterval(self.pingInterval),this.emit("notlistening"),e&&this.startListening()},h.prototype.onBridgeDisconnected=function(e){var t=this.bridges[e.domain];t&&(delete this.bridges[e.domain],local.unregisterLocal(e.domain))},h.prototype.onPageClose=function(){var e=Object.keys(this.bridges);if(this.connectedToRelay&&0!==e.length){var t=[];for(var r in this.bridges)t.push(this.bridges[r].config.peer);var n=new XMLHttpRequest;n.open("POST",this.p2pwRelayAPI.context.url,!1),n.setRequestHeader("Authorization","Bearer "+this.accessToken),n.setRequestHeader("Content-type","application/json"),n.send(JSON.stringify({src:this.myPeerDomain,dst:t,msg:{type:"disconnect"}}))}};var g=/^(.+)@(.+)!(.+):([\d]+)$/i;h.prototype.makeDomain=function(e,t,r){return e+"@"+this.providerDomain+"!"+t+":"+(r||"0")}}();var j={register:m,unregister:v,get:b},H={};local.schemes=j,local.schemes.register(["http","https"],function(e,t){var r=local.parseUri(e.url);if(e.query){var n=local.contentTypes.serialize(e.query,"application/x-www-form-urlencoded");n&&(r.query?(r.query+="&"+n,r.relative+="&"+n):(r.query=n,r.relative+="?"+n))}var i=(r.protocol?r.protocol+"://":"//")+r.authority+r.relative,o=new XMLHttpRequest;o.open(e.method,i,!0),e.binary&&(o.responseType="arraybuffer",e.stream&&console.warn("Got HTTP/S request with binary=true and stream=true - sorry, not supported, binary responses must be buffered (its a browser thing)",e)),e.serializeHeaders();for(var s in e.headers)null!==e.headers[s]&&e.headers.hasOwnProperty(s)&&o.setRequestHeader(s,e.headers[s]);var a="";e.on("data",function(e){a+=e}),e.on("end",function(){o.send(a)}),e.on("close",function(){o.readyState!==XMLHttpRequest.DONE&&o.abort()});var l=0,c=0,u=!1;o.onreadystatechange=function(){if(o.readyState>=XMLHttpRequest.HEADERS_RECEIVED&&!u){u=!0;var e={};if(0!==o.status){if(o.getAllResponseHeaders())o.getAllResponseHeaders().split("\n").forEach(function(t){if(t){var r=t.replace("\r","").split(": ");e[r[0].toLowerCase()]=r[1]}});else{var r=function(t){var r=o.getResponseHeader(t);r&&(e[t.toLowerCase()]=r.toLowerCase())};r("Accept-Ranges"),r("Age"),r("Allow"),r("Cache-Control"),r("Connection"),r("Content-Encoding"),r("Content-Language"),r("Content-Length"),r("Content-Location"),r("Content-MD5"),r("Content-Disposition"),r("Content-Range"),r("Content-Type"),r("Date"),r("ETag"),r("Expires"),r("Last-Modified"),r("Link"),r("Location"),r("Pragma"),r("Refresh"),r("Retry-After"),r("Server"),r("Set-Cookie"),r("Trailer"),r("Transfer-Encoding"),r("Vary"),r("Via"),r("Warning"),r("WWW-Authenticate")}e.link&&(e.link=local.parseLinkHeader(e.link))}t.writeHead(o.status,o.statusText,e),t.binary||(l=setInterval(function(){var e=o.response.length;if(e>c){var r=o.response.slice(c);c=e,t.write(r)}},50))}o.readyState===XMLHttpRequest.DONE&&(l&&clearInterval(l),0!==t.status&&0===o.status?(console.debug("XHR looks like it timed out; treating it as a premature close"),t.close()):(o.response&&t.write(o.response.slice(c)),t.end()))}});var _={fn:function(e,t){t.writeHead(404,"server not found"),t.end()},context:null};local.schemes.register("httpl",function(e,t){var r=local.getLocal(e.urld.authority);if(r||(r=_),e.path=e.urld.path,e.path=e.path?e.path.replace(/(.)\/$/,"$1"):"/",e.urld.query){var n=local.contentTypes.deserialize(e.urld.query,"application/x-www-form-urlencoded");e.query||(e.query={});for(var i in n)e.query[i]=n[i]}e.binary&&console.warn("Got HTTPL request with binary=true - sorry, not currently supported",e),r.fn.call(r.context,e,t)}),local.schemes.register("data",function(e,t){for(var r,n=e.url.indexOf(":"),i=e.url.indexOf(","),o=e.url.slice(n+1,i).split(";"),s=o.shift(),a=!1;r=o.shift();)"base64"==r&&(a=!0);var l=e.url.slice(i+1);l||(l=""),l=a?atob(l):decodeURIComponent(l),setTimeout(function(){t.writeHead(200,"ok",{"content-type":s}),t.end(l)})});var B={};local.registerLocal=function(e,t,r){if(B[e])throw new Error("server already registered at domain given to registerLocal");var n=t instanceof local.Server;n&&(r=t,t=t.handleLocalWebRequest,r.config.domain=e),B[e]={fn:t,context:r}},local.unregisterLocal=function(e){B[e]&&delete B[e]},local.getLocal=function(e){return B[e]},local.getLocalRegistry=function(){return B};var F;local.dispatch=function(e){if(!e)throw new Error("no request param provided to request");if("string"==typeof e&&(e={url:e}),!e.url)throw new Error("no url on request");var t=A(e.url);if("nav"==t){var r=e.url;return delete e.url,local.navigator(r).dispatch(e)}var n=null,i=!1;if(e instanceof local.Request||(n=e.body,e=new local.Request(e),i=!0),Object.defineProperty(e,"urld",{value:local.parseUri(e.url),configurable:!0,enumerable:!1,writable:!0}),e.urld.query){var o=local.contentTypes.deserialize(e.urld.query,"application/x-www-form-urlencoded");for(var s in o)e.query[s]=o[s];e.urld.relative=e.urld.path+(e.urld.anchor?"#"+e.urld.anchor:""),e.url=e.urld.protocol+"://"+e.urld.authority+e.urld.relative}var a,l=new local.Response,c=local.promise();e.on("close",function(){l.close()}),l.on("headers",function(){w(e,l)}),l.on("close",function(){l.latency=Date.now()-a,e.close()}),e.stream?l.on("headers",function(e){local.fulfillResponsePromise(c,e)}):l.on("close",function(){local.fulfillResponsePromise(c,l)}),e.suspendEvents(),l.suspendEvents();var u=function(e,r,o){return a=Date.now(),o=o||local.schemes.get(t),o?(o(e,r),e.resumeEvents(),r.resumeEvents(),i&&e.end(n)):(r.writeHead(0,'unsupported scheme "'+t+'"'),r.end(),e.resumeEvents(),r.resumeEvents()),c},h=Array.prototype.slice.call(arguments,1);return h.unshift(u),h.unshift(l),h.unshift(e),setTimeout(function(){F.apply(null,h)},0),c.request=e,c},local.fulfillResponsePromise=function(e,t){t.status>=200&&t.status<400?e.fulfill(t):t.status>=400&&t.status<600||0===t.status?e.reject(t):e.fulfill(t)},local.setDispatchWrapper=function(e){F=e},local.setDispatchWrapper(function(e,t,r){r(e,t)});var M=/(:\/\/)|(^[-A-z0-9]*\.[-A-z0-9]*)/;local.subscribe=function(e){"string"==typeof e&&(e={url:e}),e.stream=!0,e.method||(e.method="GET"),e.headers||(e.headers={accept:"text/event-stream"}),e.headers.accept||(e.headers.accept="text/event-stream");var t=local.dispatch(e);return new S(t.request,t)},local.EventStream=S,S.prototype=Object.create(local.util.EventEmitter.prototype),S.prototype.getUrl=function(){return this.request.url},S.prototype.connect=function(e){var t,r=this,n="";this.response_=e,e.then(function(e){return r.isConnOpen=!0,r.response=e,e.on("data",function(e){for(e=n+e;-1!==(t=e.indexOf("\r\n\r\n"));){var i=e.slice(0,t);C.call(r,i),e=e.slice(t+4)}n=e}),e.on("end",function(){r.close()}),e.on("close",function(){r.isConnOpen&&r.reconnect()}),e},function(e){throw r.response=e,E.call(r,{event:"error",data:e}),r.close(),e})},S.prototype.reconnect=function(){this.isConnOpen&&(this.isConnOpen=!1,this.request.close()),this.request=new local.Request(this.request),this.request.headers||(this.request.headers={}),this.lastEventId&&(this.request.headers["last-event-id"]=this.lastEventId),this.connect(local.dispatch(this.request)),this.request.end()},S.prototype.close=function(){this.isConnOpen&&(this.isConnOpen=!1,this.request.close(),this.emit("close"))},local.Broadcaster=R,R.prototype.addStream=function(e){e.broadcastStreamId=this.streams.length,this.streams.push(e);var t=this;return e.on("close",function(){t.endStream(e)}),e.broadcastStreamId},R.prototype.endStream=function(e){"number"==typeof e&&(e=this.streams[e]),delete this.streams[e.broadcastStreamId],e.end()},R.prototype.endAllStreams=function(){this.streams.forEach(function(e){e.end()}),this.streams.length=0},R.prototype.emit=function(e,t,r){r||(r={}),r.exclude&&(Array.isArray(r.exclude)||(r.exclude=[r.exclude]),r.exclude=r.exclude.map(function(e){return e instanceof local.Response?e.broadcastStreamId:e},this)),this.streams.forEach(function(n,i){r.exclude&&-1!==r.exclude.indexOf(i)||this.emitTo(n,e,t)},this)},R.prototype.emitTo=function(e,t,r){"number"==typeof e&&(e=this.streams[e]),e.write({event:t,data:r})},local.broadcaster=function(){return new R},function(e){"use strict";function t(e){var r;if(null===e||void 0===e)return!1;if(n.isArray(e))return e.length>0;if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return!0;for(r in e)if(e.hasOwnProperty(r)&&t(e[r]))return!0;return!1}var r=function(){function e(e){this.options=e}return e.prototype.toString=function(){return JSON&&JSON.stringify?JSON.stringify(this.options):this.options},e}(),n=function(){function e(e){return"[object Array]"===Object.prototype.toString.apply(e)}function t(e){return"[object String]"===Object.prototype.toString.apply(e)}function r(e){return"[object Number]"===Object.prototype.toString.apply(e)}function n(e){return"[object Boolean]"===Object.prototype.toString.apply(e)}function i(e,t){var r,n="",i=!0;for(r=0;r<e.length;r+=1)i?i=!1:n+=t,n+=e[r];return n}function o(e,t){for(var r=[],n=0;n<e.length;n+=1)r.push(t(e[n]));return r}function s(e,t){for(var r=[],n=0;n<e.length;n+=1)t(e[n])&&r.push(e[n]);return r}function a(e){if("object"!=typeof e||null===e)return e;Object.freeze(e);var t,r;for(r in e)e.hasOwnProperty(r)&&(t=e[r],"object"==typeof t&&l(t));return e}function l(e){return"function"==typeof Object.freeze?a(e):e}return{isArray:e,isString:t,isNumber:r,isBoolean:n,join:i,map:o,filter:s,deepFreeze:l}}(),i=function(){function e(e){return e>="a"&&"z">=e||e>="A"&&"Z">=e}function t(e){return e>="0"&&"9">=e}function r(e){return t(e)||e>="a"&&"f">=e||e>="A"&&"F">=e}return{isAlpha:e,isDigit:t,isHexDigit:r}}(),o=function(){function e(e){return e.length>1?e:"0"+e}function t(t){var r,n,i="",o=a.encode(t);for(n=0;n<o.length;n+=1)r=o.charCodeAt(n),i+="%"+e(r.toString(16).toUpperCase());return i}function r(e,t){return"%"===e.charAt(t)&&i.isHexDigit(e.charAt(t+1))&&i.isHexDigit(e.charAt(t+2))}function n(e,t){return parseInt(e.substr(t,2),16)}function o(e){if(!r(e,0))return!1;var t=n(e,1),i=a.numBytes(t);if(0===i)return!1;for(var o=1;i>o;o+=1)if(!r(e,3*o)||!a.isValidFollowingCharCode(n(e,3*o+1)))return!1;return!0}function s(e,t){var i=e.charAt(t);if(!r(e,t))return i;var o=n(e,t+1),s=a.numBytes(o);if(0===s)return i;for(var l=1;s>l;l+=1)if(!r(e,t+3*l)||!a.isValidFollowingCharCode(n(e,t+3*l+1)))return i;return e.substr(t,3*s)}var a={encode:function(e){return unescape(encodeURIComponent(e))},numBytes:function(e){return 127>=e?1:e>=194&&223>=e?2:e>=224&&239>=e?3:e>=240&&244>=e?4:0},isValidFollowingCharCode:function(e){return e>=128&&191>=e}};return{encodeCharacter:t,isPctEncoded:o,pctCharAt:s}}(),s=function(){function e(e){return i.isAlpha(e)||i.isDigit(e)||"_"===e||o.isPctEncoded(e)}function t(e){return i.isAlpha(e)||i.isDigit(e)||"-"===e||"."===e||"_"===e||"~"===e}function r(e){return":"===e||"/"===e||"?"===e||"#"===e||"["===e||"]"===e||"@"===e||"!"===e||"$"===e||"&"===e||"("===e||")"===e||"*"===e||"+"===e||","===e||";"===e||"="===e||"'"===e}return{isVarchar:e,isUnreserved:t,isReserved:r}}(),a=function(){function e(e,t){var r,n="",i="";for(("number"==typeof e||"boolean"==typeof e)&&(e=e.toString()),r=0;r<e.length;r+=i.length)i=e.charAt(r),n+=s.isUnreserved(i)||t&&s.isReserved(i)?i:o.encodeCharacter(i);return n}function t(t){return e(t,!0)}function r(e,t){var r=o.pctCharAt(e,t);return r.length>1?r:s.isReserved(r)||s.isUnreserved(r)?r:o.encodeCharacter(r)}function n(e){var t,r="",n="";for(t=0;t<e.length;t+=n.length)n=o.pctCharAt(e,t),r+=n.length>1?n:s.isReserved(n)||s.isUnreserved(n)?n:o.encodeCharacter(n);return r}return{encode:e,encodePassReserved:t,encodeLiteral:n,encodeLiteralCharacter:r}}(),l=function(){function e(e){t[e]={symbol:e,separator:"?"===e?"&":""===e||"+"===e||"#"===e?",":e,named:";"===e||"&"===e||"?"===e,ifEmpty:"&"===e||"?"===e?"=":"",first:"+"===e?"":e,encode:"+"===e||"#"===e?a.encodePassReserved:a.encode,toString:function(){return this.symbol}}}var t={};return e(""),e("+"),e("#"),e("."),e("/"),e(";"),e("?"),e("&"),{valueOf:function(e){return t[e]?t[e]:"=,!@|".indexOf(e)>=0?null:t[""]}}}(),c=function(){function e(e){this.literal=a.encodeLiteral(e)}return e.prototype.expand=function(){return this.literal},e.prototype.toString=e.prototype.expand,e}(),u=function(){function e(e){function t(){var t=e.substring(f,c);if(0===t.length)throw new r({expressionText:e,message:"a varname must be specified",position:c});p={varname:t,exploded:!1,maxLength:null},f=null}function n(){if(d===c)throw new r({expressionText:e,message:"after a ':' you have to specify the length",position:c});p.maxLength=parseInt(e.substring(d,c),10),d=null}var a,c,u=[],p=null,f=null,d=null,y="";for(a=function(t){var n=l.valueOf(t);if(null===n)throw new r({expressionText:e,message:"illegal use of reserved operator",position:c,operator:t});return n}(e.charAt(0)),c=a.symbol.length,f=c;c<e.length;c+=y.length){if(y=o.pctCharAt(e,c),null!==f){if("."===y){if(f===c)throw new r({expressionText:e,message:"a varname MUST NOT start with a dot",position:c});continue}if(s.isVarchar(y))continue;t()}if(null!==d){if(c===d&&"0"===y)throw new r({expressionText:e,message:"A :prefix must not start with digit 0",position:c});if(i.isDigit(y)){if(c-d>=4)throw new r({expressionText:e,message:"A :prefix must have max 4 digits",position:c});continue}n()}if(":"!==y)if("*"!==y){if(","!==y)throw new r({expressionText:e,message:"illegal character",character:y,position:c});u.push(p),p=null,f=c+1}else{if(null===p)throw new r({expressionText:e,message:"exploded without varspec",position:c});if(p.exploded)throw new r({expressionText:e,message:"exploded twice",position:c});if(p.maxLength)throw new r({expressionText:e,message:"an explode (*) MUST NOT follow to a prefix",position:c});p.exploded=!0}else{if(null!==p.maxLength)throw new r({expressionText:e,message:"only one :maxLength is allowed per varspec",position:c});if(p.exploded)throw new r({expressionText:e,message:"an exploeded varspec MUST NOT be varspeced",position:c});d=c+1}}return null!==f&&t(),null!==d&&n(),u.push(p),new h(e,a,u)}function t(t){var n,i,o=[],s=null,a=0;for(n=0;n<t.length;n+=1)if(i=t.charAt(n),null===a){if(null===s)throw new Error("reached unreachable code");if("{"===i)throw new r({templateText:t,message:"brace already opened",position:n});if("}"===i){if(s+1===n)throw new r({templateText:t,message:"empty braces",position:s});try{o.push(e(t.substring(s+1,n)))}catch(l){if(l.prototype===r.prototype)throw new r({templateText:t,message:l.options.message,position:s+l.options.position,details:l.options});throw l}s=null,a=n+1}}else{if("}"===i)throw new r({templateText:t,message:"unopened brace closed",position:n});"{"===i&&(n>a&&o.push(new c(t.substring(a,n))),a=null,s=n)}if(null!==s)throw new r({templateText:t,message:"unclosed brace",position:s});return a<t.length&&o.push(new c(t.substr(a))),new p(t,o)}return t}(),h=function(){function e(e){return JSON&&JSON.stringify?JSON.stringify(e):e}function r(e){if(!t(e))return!0;if(n.isString(e))return""===e;if(n.isNumber(e)||n.isBoolean(e))return!1;if(n.isArray(e))return 0===e.length;for(var r in e)if(e.hasOwnProperty(r))return!1;return!0}function i(e){var t,r=[];for(t in e)e.hasOwnProperty(t)&&r.push({name:t,value:e[t]});return r}function o(e,t,r){this.templateText=e,this.operator=t,this.varspecs=r}function s(e,t,r){var n="";if(r=r.toString(),t.named){if(n+=a.encodeLiteral(e.varname),""===r)return n+=t.ifEmpty;n+="="}return null!==e.maxLength&&(r=r.substr(0,e.maxLength)),n+=t.encode(r)}function l(e){return t(e.value)}function c(e,o,s){var c=[],u="";if(o.named){if(u+=a.encodeLiteral(e.varname),r(s))return u+=o.ifEmpty;u+="="}return n.isArray(s)?(c=s,c=n.filter(c,t),c=n.map(c,o.encode),u+=n.join(c,",")):(c=i(s),c=n.filter(c,l),c=n.map(c,function(e){return o.encode(e.name)+","+o.encode(e.value)}),u+=n.join(c,",")),u}function u(e,o,s){var c=n.isArray(s),u=[];return c?(u=s,u=n.filter(u,t),u=n.map(u,function(t){var n=a.encodeLiteral(e.varname);return n+=r(t)?o.ifEmpty:"="+o.encode(t)})):(u=i(s),u=n.filter(u,l),u=n.map(u,function(e){var t=a.encodeLiteral(e.name);return t+=r(e.value)?o.ifEmpty:"="+o.encode(e.value)})),n.join(u,o.separator)}function h(e,r){var o=[],s="";return n.isArray(r)?(o=r,o=n.filter(o,t),o=n.map(o,e.encode),s+=n.join(o,e.separator)):(o=i(r),o=n.filter(o,function(e){return t(e.value)}),o=n.map(o,function(t){return e.encode(t.name)+"="+e.encode(t.value)}),s+=n.join(o,e.separator)),s}return o.prototype.toString=function(){return this.templateText},o.prototype.expand=function(i){var o,a,l,p,f=[],d=!1,y=this.operator;for(o=0;o<this.varspecs.length;o+=1)if(a=this.varspecs[o],l=i[a.varname],null!==l&&void 0!==l)if(a.exploded&&(d=!0),p=n.isArray(l),"string"==typeof l||"number"==typeof l||"boolean"==typeof l)f.push(s(a,y,l));else{if(a.maxLength&&t(l))throw new Error("Prefix modifiers are not applicable to variables that have composite values. You tried to expand "+this+" with "+e(l));a.exploded?t(l)&&(y.named?f.push(u(a,y,l)):f.push(h(y,l))):(y.named||!r(l))&&f.push(c(a,y,l))}return 0===f.length?"":y.first+n.join(f,y.separator)},o}(),p=function(){function e(e,t){this.templateText=e,this.expressions=t,n.deepFreeze(this)}return e.prototype.toString=function(){return this.templateText},e.prototype.expand=function(e){var t,r="";for(t=0;t<this.expressions.length;t+=1)r+=this.expressions[t].expand(e);return r},e.parse=u,e.UriTemplateError=r,e}();e(p)}(function(e){"use strict";local.UriTemplate=e}),T.UNRESOLVED=0,T.RESOLVED=1,T.FAILED=2,T.prototype.isResolved=function(){return this.resolveState===T.RESOLVED},T.prototype.isBad=function(){return this.resolveState===T.FAILED},T.prototype.isRelative=function(){return!this.queryIsAbsolute},T.prototype.isAbsolute=function(){return this.queryIsAbsolute},T.prototype.getUrl=function(){return this.url},T.prototype.getError=function(){return this.error},T.prototype.resetResolvedState=function(){this.resolveState=T.UNRESOLVED,this.error=null},T.prototype.setResolved=function(e){this.error=null,this.resolveState=T.RESOLVED,e&&(this.url=e,this.urld=local.parseUri(this.url))},T.prototype.setFailed=function(e){this.error=e,this.resolveState=T.FAILED},local.Navigator=x,x.prototype.setRequestDefaults=function(e){this.requestDefaults=e},x.prototype.dispatch=function(e){e||(e={}),e.headers||(e.headers={});var t=this;return this.requestDefaults&&k(e,this.requestDefaults),(e.url?local.promise(e.url):this.resolve({retry:e.retry,nohead:!0})).succeed(function(t){return e.url=t,local.dispatch(e)}).succeed(function(e){return t.context.setResolved(),t.links=e.headers.link?e.headers.link:t.links||[],e}).fail(function(e){throw(e.status===local.LINK_NOT_FOUND||404===e.status)&&t.context.setFailed(e),e})},x.prototype.subscribe=function(e){var t=this;return e||(e={}),this.resolve({nohead:!0}).succeed(function(r){return e.url=r,t.requestDefaults&&k(e,t.requestDefaults),local.subscribe(e)})},x.prototype.follow=function(e){"string"==typeof e&&local.isNavSchemeUri(e)&&(e=local.parseNavUri(e)),Array.isArray(e)||(e=[e]);var t=this;do t=new x(new T(e.shift()),t),this.requestDefaults&&t.setRequestDefaults(this.requestDefaults);while(e[0]);return t},x.prototype.unresolve=function(){return this.context.resetResolvedState(),this.links=null,this},x.prototype.rebase=function(e){return this.unresolve(),this.context.query=e,this.context.queryIsAbsolute=!0,this.context.url=e,this.context.urld=local.parseUri(e),this},x.prototype.resolve=function(e){var t=this;e=e||{};var r=e.nohead;delete e.nohead;var n=local.promise();if(null!==this.links&&(this.context.isResolved()||this.context.isAbsolute()&&this.context.isBad()===!1))n.fulfill(this.context.getUrl());else if(this.context.isBad()===!1||this.context.isBad()&&e.retry)if(this.context.resetResolvedState(),this.context.isRelative()){if(!this.parentNavigator)throw new Error("Relative navigator has no parent");n=this.parentNavigator.resolve(e).succeed(function(){var e=t.parentNavigator.lookupLink(t.context);if(e)return t.context.setResolved(e),r?e:t.dispatch({method:"HEAD",url:e}).succeed(function(){return e});var n=new local.Response;throw n.writeHead(local.LINK_NOT_FOUND,"link query failed to match").end(),n}).fail(function(e){throw t.context.setFailed(e),e})}else r?n.fulfill(t.context.getUrl()):n=this.dispatch({method:"HEAD",url:t.context.getUrl()}).succeed(function(){return t.context.getUrl()});else n.reject(this.context.getError());return n},x.prototype.lookupLink=function(e){if(e.query)if("object"==typeof e.query){var t=local.queryLinks1(this.links,e.query);if(t)return local.UriTemplate.parse(t.href).expand(e.query)}else if("string"==typeof e.query)return local.isAbsUrl(e.query)?e.query:local.joinRelPath(this.context.urld,e.query);return console.log("Failed to find a link to resolve context. Link query:",e.query,"Navigator:",this),null},x.prototype.head=P("HEAD"),x.prototype.get=P("GET"),x.prototype.delete=P("DELETE"),x.prototype.post=O("POST"),x.prototype.put=O("PUT"),x.prototype.patch=O("PATCH"),x.prototype.notify=O("NOTIFY"),local.navigator=function(e){if(e instanceof x)return e;"string"==typeof e&&local.isNavSchemeUri(e)&&(e=local.parseNavUri(e)),Array.isArray(e)||(e=[e]);for(var t=new x(new T(e.shift()));e[0];)t=new x(new T(e.shift()),t);return t},local.registerLocal("hosts",function(e,t){var r=local.getLocalRegistry();if("HEAD"!=e.method&&"GET"!=e.method)return t.writeHead(405,"bad method").end();if("GET"==e.method&&!local.preferredType(e,"application/json"))return t.writeHead(406,"bad accept - only provides application/json").end();var n=[],i=[];i.push({href:"/",rel:"self service via",id:"hosts"});for(var o in r)"hosts"!=o&&(n.push(o),i.push({href:"httpl://"+o,id:o,rel:"service"}));return t.setHeader("link",i),"HEAD"==e.method?t.writeHead(204,"ok, no content").end():(t.writeHead(200,"ok",{"content-type":"application/json"}),t.end({host_names:n}),void 0)})}(),"undefined"==typeof this.local&&(this.local={}),"undefined"==typeof this.local.worker&&(this.local.worker={}),function(){function e(e,r){var n=local.worker.hostPage;try{n.channelSendMsg({op:"log",body:[e].concat(r)})}catch(i){n.channelSendMsg({op:"log",body:[e].concat(r.map(t))})}}function t(e){return Array.isArray(e)?e.map(t):e&&"object"==typeof e?JSON.stringify(e):e}function r(e,t){var r=255&e.charCodeAt(t);return r}function n(e){var t=!local.worker.hostPage,r=new local.worker.PageServer(local.worker.pages.length,e,t);t&&(local.worker.hostPage=r),local.worker.pages.push(r),local.registerLocal(r.id+".page",r),e.start&&e.start(),r.channelSendMsg({op:"ready",body:{hostPrivileges:t}}),local.worker.emit("connect",{page:r})}!function(){function e(e,t,r){local.BridgeServer.call(this),this.id=e,this.port=t,this.isHostPage=r,this.port.addEventListener("message",function(e){var t=e.data;if(!t)return console.error("Invalid message from page: Payload missing",e);switch(t.op){case"configure":this.onPageConfigure(t.body);break;case"nullify":this.onPageNullify(t.body);break;case"importScripts":this.onPageImportScripts(t.body);break;case"terminate":this.terminate();break;default:this.onChannelMessage(t)}}.bind(this))}e.prototype=Object.create(local.BridgeServer.prototype),local.worker.PageServer=e,e.prototype.isChannelActive=function(){return!0},e.prototype.channelSendMsg=function(e){this.port.postMessage(e)},e.prototype.handleRemoteWebRequest=function(e,t){main?main(e,t,this):(t.writeHead(500,"worker main() not implemented"),t.end())},e.prototype.onPageConfigure=function(e){return this.isHostPage?(local.worker.config=e,void 0):(console.log('rejected "configure" from non-host connection'),void 0)},e.prototype.onPageNullify=function(e){if(!this.isHostPage)return console.log('rejected "nullify" from non-host connection'),void 0;if(console.log("nullifying: "+e),"string"!=typeof e)throw new Error("'nullify' message must include a valid string");self[e]=null},e.prototype.onPageImportScripts=function(e){if(!this.isHostPage)return console.log('rejected "importScripts" from non-host connection'),void 0;if(!e)return console.error("'importScripts' message must include a valid array/string"),this.channelSendMsg({op:"loaded",body:{error:!0,reason:"No script URI provided"}}),void 0;try{i(e)}catch(t){return console.error(t?t.toString():t,t?t.stack:t),this.channelSendMsg({op:"loaded",body:{error:!0,reason:t?t.toString():t}}),void 0}this.channelSendMsg({op:"loaded",body:{error:!1}})}}(),local.util.mixinEventEmitter(local.worker);var i=importScripts;if(self.console={log:function(){var t=Array.prototype.slice.call(arguments);e("log",t)},dir:function(){var t=Array.prototype.slice.call(arguments);e("dir",t)},debug:function(){var t=Array.prototype.slice.call(arguments);e("debug",t)},warn:function(){var t=Array.prototype.slice.call(arguments);e("warn",t)},error:function(){var t=Array.prototype.slice.call(arguments);e("error",t)}},!self.btoa){var o="=",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";self.btoa=function(e){var t,n,i=o,a=s,l=[];
e=""+e;var c=e.length-e.length%3;if(0===e.length)return e;for(t=0;c>t;t+=3)n=r(e,t)<<16|r(e,t+1)<<8|r(e,t+2),l.push(a.charAt(n>>18)),l.push(a.charAt(63&n>>12)),l.push(a.charAt(63&n>>6)),l.push(a.charAt(63&n));switch(e.length-c){case 1:n=r(e,t)<<16,l.push(a.charAt(n>>18)+a.charAt(63&n>>12)+i+i);break;case 2:n=r(e,t)<<16|r(e,t+1)<<8,l.push(a.charAt(n>>18)+a.charAt(63&n>>12)+a.charAt(63&n>>6)+i)}return l.join("")}}local.worker.pages=[],addEventListener("connect",function(e){n(e.ports[0])}),self.postMessage&&n(self)}();